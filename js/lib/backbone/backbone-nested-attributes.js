!function(e,t){function n(e,n){return n&&t(e.relations).each(function(t){"one"==t.type?i(e,t,n):o(e,t,n)}),a(e),n}function i(n,i,o){var s=i.key,d=o[s],a=t(i).result("relatedModel");d&&(d=d instanceof e.Model?d:new a(d),r(n,d,i),o[s]=d)}function o(e,t,n){var i=t.key,o=n[i],d=n["deleted_"+i],a=e.get(i),l=a||c(t);return o=s(o),r(e,l,t),o&&l.set(o),d&&(delete n["deleted_"+i],d=s(d),l.deletedModels.set(d)),n[i]=l,n}function s(t){return t instanceof e.Collection?t.slice():t}function d(e){t(e.relations).each(function(t){var n=e.get(t.key);n&&n.each&&(n.each(function(e){d(e)}),n.deletedModels&&n.deletedModels.reset())})}function a(e){e._hasNestedAttributesEventsConfigured||(e.on("sync",d),e._hasNestedAttributesEventsConfigured=!0)}function r(e,t,n){t._hasEventBubblingConfigured||(e.listenTo(t,"add change nested:change remove",function(t,i){e.trigger("nested:change change:"+n.key,t,i)}),t._hasEventBubblingConfigured=!0)}function l(e){t(e.relations).each(function(t){var n=e.get(t.key);e.stopListening(n),n.off("remove",f,n),n.deletedModels&&n.deletedModels.reset()},e)}function u(e,n,i){return t(n).each(function(n){var o,s=n.key,d=e[s],a=[];d&&(i&&(i.withDeleted&&d.deletedModels&&(e["deleted_"+s]=d.deletedModels.toJSON(i)),i.nested&&(d.deletedModels&&(a=d.deletedModels.toJSON(i)),delete e[s],s+="_attributes")),o=d.toJSON(i),t(o).isArray()&&(o=o.concat(a)),d&&i&&i.nested&&n.serialize_keys&&(o=t(o).isArray()?t.map(o,function(e){return t.pick(e,n.serialize_keys)}):t.pick(o,n.serialize_keys)),e[s]=o)}),e}function c(n){var i=t(n).result("collectionType")||e.Collection,o=new i;return o.model=t(n).result("relatedModel")||o.model,o.destroy_action=n.destroy_action||"_destroy",n.serialize_keys&&n.serialize_keys.push(o.destroy_action),o.deletedModels=new e.Collection,o.deletedModels.model=o.model,o.on("add",h),o.on("remove",f),o}function h(e,t){e.get(t.destroy_action)&&e.unset(t.destroy_action,{silent:!0}),e.isNew()||t.deletedModels.remove(e)}function f(e,t){e.isNew()||(param={},param[t.destroy_action]=!0,e.set(param,{silent:!0}),t.deletedModels.add(e))}var g=e.Model.prototype;e.NestedAttributesModel=e.Model.extend({set:function(e,i,o){var s;return t.isObject(e)||null==e?(s=e,o=i):(s={},s[e]=i),g.set.call(this,n(this,s),o)},toJSON:function(e){return u(g.toJSON.apply(this,arguments),this.relations,e)},clone:function(){return new this.constructor(this.toJSON())},clear:function(e){return l(this),g.clear.apply(this,arguments)}})}(Backbone,_),function(e,t){function n(e){this.model=e,e.on("nested:change",this.change,this),e.on("change",this.change,this),e.on("sync",this.save,this)}var i=e.NestedAttributesModel,o=i.prototype;t.extend(n.prototype,e.Events,{change:function(){this.changed=!0},save:function(){this.updateAttributes(),this.model.trigger("state:store")},undo:function(){this.attributesToUnset().each(function(e){this.model.unset(e)},this),this.model.set(this.attributes),this.updateAttributes(),this.model.trigger("state:restore")},attributesToUnset:function(){var e=t(this.attributes||{}).keys();return t(this.model.attributes).chain().keys().select(function(n){return!t(e).include(n)})},updateAttributes:function(){this.attributes=this.model.toJSON({withDeleted:!0}),this.changed=!1}}),e.UndoableModel=i.extend({initialize:function(){o.initialize.apply(this,arguments),this.undoable()},undoable:function(){this.saveState()},undo:function(){this.undoableState().undo()},hasChangedSinceSync:function(){return this.undoableState().changed===!0},saveState:function(){this.undoableState().save()},undoableState:function(){return this._undoableState=this._undoableState||new n(this)}})}(Backbone,_);